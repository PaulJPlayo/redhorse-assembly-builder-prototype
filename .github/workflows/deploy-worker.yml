name: Deploy OpenNext Worker

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    concurrency:
      group: deploy-worker-main
      cancel-in-progress: true
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Diagnostics
        run: |
          node -v
          npm -v
          uname -a
          free -h || true
          df -h
          npx wrangler --version

      - name: Verify required secrets
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then echo "Missing CLOUDFLARE_API_TOKEN secret"; exit 1; fi
          if [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then echo "Missing CLOUDFLARE_ACCOUNT_ID secret"; exit 1; fi

      - name: Install
        run: npm ci

      - name: Build (OpenNext)
        run: npm run build:cf

      - name: Deploy (Cloudflare Worker)
        run: npm run deploy:cf
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_WORKER_NAME: redhorse-assembly-builder

      - name: Verify Worker URL
        run: curl -I -sS https://redhorse-assembly-builder.oraclecoding8.workers.dev/assembly | head -n 20
